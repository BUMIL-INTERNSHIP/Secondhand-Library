<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>지점 마커 지도</title>
    <style>
        html, body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: row;
        }
        .map_wrap {
            flex: 1;
            position: relative;
        }
        #map {
            width: 100%;
            height: 100%;
        }
        #menu_wrap {
            width: 300px;
            height: 100%;
            overflow-y: auto;
            background: rgba(255, 255, 255, 0.7);
            z-index: 1;
            font-size: 12px;
            border-left: 1px solid #888;
            box-sizing: border-box;
        }
        .bg_white {
            background: #fff;
        }
        #menu_wrap hr {
            display: block;
            height: 1px;
            border: 0;
            border-top: 2px solid #5F5F5F;
            margin: 3px 0;
        }
        #placesList {
            padding-inline-start: 0;
            margin: 0px;
        }
        #placesList li {
            list-style: none;
            padding: 10px;
            position: relative;
        }
        #placesList .item {
            border-bottom: 1px solid #888;
            overflow: hidden;
            cursor: pointer;
            min-height: 65px;
        }
        #placesList .item span {
            display: block;
            margin-top: 4px;
        }
        #placesList .item h5, #placesList .item .info {
            text-overflow: ellipsis;
            overflow: hidden;
            white-space: nowrap;
        }
        #placesList .item .info {
            padding: 10px 0 10px 55px;
        }
        #placesList .info .gray {
            color: #8a8a8a;
        }
        #placesList .info .jibun {
            padding-left: 26px;
            background: url(https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/places_jibun.png) no-repeat;
        }
        #placesList .info .tel {
            color: #009900;
        }
<!--        #placesList .item .markerbg {-->
<!--            float: left;-->
<!--            width: 36px;-->
<!--            height: 37px;-->
<!--            margin: 10px 0 0 10px;-->
<!--            background: url(https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/marker_red.png) no-repeat;-->
<!--            position: absolute;-->
<!--            left: 0;-->
<!--            top: 0;-->
<!--        }-->
    </style>
</head>
<body>
<div class="map_wrap">
    <div id="map"></div>
</div>
<div id="menu_wrap" class="bg_white">
    <ul id="placesList"></ul>
</div>

<script th:inline="javascript">
    var stores = /*[[${stores}]]*/ '[]'; // 서버에서 stores 목록을 전달받음
</script>

<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=bc9537699d03799a297967214e3bbd2e&libraries=services"></script>
<script>
    // 마커를 담을 배열입니다
    var markers = [];

    var mapContainer = document.getElementById('map'), // 지도를 표시할 div
        mapOption = {
            center: new kakao.maps.LatLng(37.566826, 126.9786567), // 지도의 중심좌표
            level: 12 // 지도의 확대 레벨
        };

    console.log("Map container:", mapContainer);

    // 지도를 생성합니다
    var map = new kakao.maps.Map(mapContainer, mapOption);

    // 장소 검색 객체를 생성합니다
    var ps = new kakao.maps.services.Places();

    // 검색 결과 목록이나 마커를 클릭했을 때 장소명을 표출할 인포윈도우를 생성합니다
    var infowindow = new kakao.maps.InfoWindow({zIndex: 1});

    // stores 변수의 형태를 콘솔에 출력합니다
    console.log("stores:", stores);

    // stores 데이터가 배열인지 확인하고, 배열로 처리합니다
    if (typeof stores === 'string') {
        try {
            stores = JSON.parse(stores);
        } catch (e) {
            console.error("Failed to parse stores JSON:", e);
            stores = [];
        }
    }

    // stores 배열을 출력하여 확인합니다
    console.log("Parsed stores array:", stores);

    displayStores(stores);

    // stores 목록을 지도에 표시하는 함수입니다
    function displayStores(stores) {
        var bounds = new kakao.maps.LatLngBounds();
        var listEl = document.getElementById('placesList');
        removeAllChildNods(listEl);

        for (var i = 0; i < stores.length; i++) {
            var store = "알라딘 " + stores[i];
            console.log("Searching for store:", store);
            ps.keywordSearch(store, (function (storeName, index) {
                return function (data, status) {
                    if (status === kakao.maps.services.Status.OK) {
                        var place = data[0]; // 검색된 첫 번째 장소 사용
                        console.log("Place found for store:", storeName, place);
                        var placePosition = new kakao.maps.LatLng(place.y, place.x);
                        var marker = addMarker(placePosition, storeName);

                        bounds.extend(placePosition);

                        var itemEl = getListItem(index, place); // 검색 결과 항목 Element를 생성합니다
                        listEl.appendChild(itemEl);

                        // 마커와 검색결과 항목에 mouseover 했을때 인포윈도우에 장소명을 표시합니다
                        (function (marker, title) {
                            kakao.maps.event.addListener(marker, 'mouseover', function () {
                                displayInfowindow(marker, title);
                            });

                            kakao.maps.event.addListener(marker, 'mouseout', function () {
                                infowindow.close();
                            });

                            itemEl.onmouseover = function () {
                                displayInfowindow(marker, title);
                            };

                            itemEl.onmouseout = function () {
                                infowindow.close();
                            };
                        })(marker, storeName);
                    } else {
                        console.log("No place found for store:", storeName);
                    }
                }
            })(store, i));
        }
    }

    // 검색결과 항목을 Element로 반환하는 함수입니다
    function getListItem(index, places) {
        var el = document.createElement('li'),
            itemStr = '<span class="markerbg marker_' + (index + 1) + '"></span>' +
                '<div class="info">' +
                '   <h5>' + places.place_name + '</h5>';

        if (places.road_address_name) {
            itemStr += '    <span>' + places.road_address_name + '</span>' +
                '   <span class="jibun gray">' + places.address_name + '</span>';
        } else {
            itemStr += '    <span>' + places.address_name + '</span>';
        }

        itemStr += '  <span class="tel">' + places.phone + '</span>' +
            '</div>';

        el.innerHTML = itemStr;
        el.className = 'item';

        return el;
    }

    // 마커를 생성하고 지도 위에 마커를 표시하는 함수입니다
    function addMarker(position, title) {
        console.log("Adding marker:", title, position);
        var marker = new kakao.maps.Marker({
            position: position // 마커의 위치
        });

        marker.setMap(map); // 지도 위에 마커를 표출합니다
        markers.push(marker); // 배열에 생성된 마커를 추가합니다

        return marker;
    }

    // 인포윈도우에 장소명을 표시합니다
    function displayInfowindow(marker, title) {
        var content = '<div style="padding:5px;z-index:1;">' + title + '</div>';

        infowindow.setContent(content);
        infowindow.open(map, marker);
    }

    // 검색결과 목록의 자식 Element를 제거하는 함수입니다
    function removeAllChildNods(el) {
        while (el.hasChildNodes()) {
            el.removeChild(el.lastChild);
        }
    }
</script>
</body>
</html>
